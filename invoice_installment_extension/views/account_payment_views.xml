<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Account Payment Form View - Add Invoices with Pending Installments Page -->
    <record id="view_account_payment_form_installments" model="ir.ui.view">
        <field name="name">account.payment.form.installments</field>
        <field name="model">account.payment</field>
        <field name="inherit_id" ref="account.view_account_payment_form"/>
        <field name="arch" type="xml">
            <!-- Add hidden fields -->
            <xpath expr="//sheet" position="inside">
                <field name="invoice_ids_with_pending_installments" invisible="1"/>
                <field name="selected_installment_invoice_ids" invisible="1"/>
            </xpath>
            <!-- Add notebook page with invoices -->
            <xpath expr="//notebook[@name='payment_notebook']" position="inside">
                <page string="Invoices" name="invoices_with_pending_installments"
                      invisible="not partner_id or partner_type != 'customer'">
                    <!-- Display invoices list (read-only) -->
                    <field name="invoice_ids_with_pending_installments" nolabel="1">
                        <list string="Invoices with Pending Installments">
                            <field name="name"/>
                            <field name="invoice_date"/>
                            <field name="amount_total" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                            <field name="amount_residual" widget="monetary" options="{'currency_field': 'currency_id'}"
                                   string="Amount Due"/>
                            <field name="installment_count" string="Total Installments"/>
                            <field name="pending_installment_count" string="Pending Installments"/>
                            <field name="paid_installment_count" string="Paid Installments"/>
                            <field name="nearest_due_installment_amount" widget="monetary" options="{'currency_field': 'currency_id'}" string="Nearest Due Amount"/>
                            <field name="nearest_due_installment_date" string="Nearest Due Date"/>
                            <field name="state" widget="badge" decoration-success="state == 'posted'" decoration-info="state == 'draft'"/>
                            <button name="action_view_installment_invoice" string="View" type="object" class="btn-primary" icon="fa-external-link"/>
                        </list>
                    </field>
                    <!-- Selection field with checkboxes -->
                    <group>
                        <field name="selected_installment_invoice_ids" 
                               string="Select Invoices"
                               domain="[('id', 'in', invoice_ids_with_pending_installments)]"
                               widget="many2many_checkboxes"
                               options="{'no_create': True, 'no_create_edit': True}"/>
                    </group>
                    <!-- Calculated fields for selected invoices -->
                    <group string="Calculated Amounts" invisible="not selected_installment_invoice_ids">
                        <group>
                            <field name="total_selected_nearest_due_amount" 
                                   widget="monetary" 
                                   options="{'currency_field': 'currency_id'}"
                                   readonly="1"/>
                            <field name="payment_amount_after_nearest_due" 
                                   widget="monetary" 
                                   options="{'currency_field': 'currency_id'}"
                                   readonly="1"/>
                        </group>
                    </group>
                </page>
            </xpath>
        </field>
    </record>
</odoo>

